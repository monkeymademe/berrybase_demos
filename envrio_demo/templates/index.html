<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviro Indoor Sensor Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-gradient-start: #3e91be;
            --bg-gradient-end: #cd3c65;
            --bg-color: #f8f8f8;
            --card-bg: white;
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --text-white: white;
            --border-color: #f0f0f0;
            --stats-panel-bg: #f8f8f8;
            --stat-box-bg: #f8f8f8;
            --sleep-overlay-bg: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-gradient-start: #6b6a6a;
            --bg-gradient-end: #cd3c65;
            --bg-color: #0f1419;
            --card-bg: #1a1f2e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --text-white: #e0e0e0;
            --border-color: #2a2f3e;
            --stats-panel-bg: #1a1f2e;
            --stat-box-bg: #0f1419;
            --sleep-overlay-bg: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease;
        }

        html[data-theme="dark"] body {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 90%, var(--bg-gradient-end) 100%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--text-white);
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .current-readings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .sensor-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 18px;
            min-width: 0; /* Allows flex shrinking */
            transition: background 0.3s ease;
        }

        .sensor-title {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sensor-value {
            font-size: 1.75em;
            font-weight: bold;
            color: #6b6a6a;
            margin-bottom: 10px;
        }

        .sensor-unit {
            font-size: 0.6em;
            color: var(--text-muted);
            font-weight: normal;
        }

        .meter-container {
            position: relative;
            height: 100px;
            margin-top: 15px;
        }

        .meter-bar {
            width: 100%;
            height: 30px;
            background: var(--border-color);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #3e91be 0%, #cd3c65 100%);
            border-radius: 15px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .meter-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255,255,255,0.3) 50%,
                transparent 100%
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .meter-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.85em;
            color: #666;
        }

        .historical-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }

        .section-title {
            font-size: 1.8em;
            color: var(--text-secondary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .time-selector {
            display: flex;
            gap: 10px;
        }

        .time-btn {
            padding: 8px 16px;
            border: 2px solid #cd3c65;
            background: var(--card-bg);
            color: #cd3c65;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.3em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .time-btn:hover {
            background: #cd3c65;
            color: white;
        }

        .time-btn.active {
            background: #cd3c65;
            color: white;
        }

        .stats-panel {
            background: var(--stats-panel-bg);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px;
            transition: background 0.3s ease;
        }

        .stat-item {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .stat-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            font-weight: 600;
            text-align: center;
        }

        .stat-values {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .stat-box {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            background: var(--stat-box-bg);
            transition: background 0.3s ease;
        }

        .stat-box.min {
            background: rgba(62, 145, 190, 0.1);
        }

        .stat-box.max {
            background: rgba(205, 60, 101, 0.1);
        }

        .stat-box.avg {
            background: rgba(107, 106, 106, 0.1);
        }

        .stat-value-label {
            font-size: 0.65em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 0.9em;
            color: #6b6a6a;
            font-weight: 500;
        }

        .stat-box.min .stat-value-label {
            color: #3e91be;
        }

        .stat-box.max .stat-value-label {
            color: #cd3c65;
        }

        .stat-box.avg .stat-value-label {
            color: #6b6a6a;
        }

        @media (max-width: 768px) {
            .stats-panel {
                grid-template-columns: 1fr;
            }
            
            .stat-values {
                gap: 6px;
            }
            
            .stat-box {
                padding: 6px;
            }
            
            .stat-value {
                font-size: 0.85em;
            }
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .expand-button {
            text-align: center;
            margin-top: 15px;
            cursor: pointer;
            user-select: none;
            transition: transform 0.3s ease;
        }

        .expand-button:hover {
            opacity: 0.8;
        }

        .expand-button.expanded {
            transform: rotate(180deg);
        }

        .expand-icon {
            width: 24px;
            height: 24px;
            color: #6b6a6a;
            display: inline-block;
            transition: transform 0.3s ease;
        }
        
        .expand-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        .additional-charts {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
            transition: border-color 0.3s ease;
        }

        .additional-charts.expanded {
            display: block;
            margin-bottom: 50px;
        }

        .additional-chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 30px;
        }

        .additional-chart-container:last-child {
            margin-bottom: 0;
        }

        .chart-title {
            font-size: 1.2em;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 600;
        }


        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: blink 2s infinite;
        }

        .status-indicator.active {
            background: #4caf50;
        }

        .status-indicator.sleeping {
            background: #ff9800;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            padding: 0;
            width: auto;
            height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .theme-toggle:hover {
            opacity: 0.7;
        }

        .theme-toggle svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
        <!-- Sun icon for light mode (shows moon to switch to dark) -->
        <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
            <path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278M4.858 1.311A7.27 7.27 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.32 7.32 0 0 0 5.205-2.162q-.506.063-1.029.063c-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286"/>
            <path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.73 1.73 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.73 1.73 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.73 1.73 0 0 0 1.097-1.097zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
        </svg>
    </button>

    <div class="container">
        <h1>
            <span class="status-indicator" id="statusIndicator"></span>
            Enviro Indoor Sensor Dashboard
        </h1>

        <div class="current-readings">
            <div class="sensor-card">
                <div class="sensor-title">Temperature</div>
                <div class="sensor-value">
                    <span id="tempValue">--</span>
                    <span class="sensor-unit">°C</span>
                </div>
                <div class="meter-container">
                    <div class="meter-bar">
                        <div class="meter-fill" id="tempMeter" style="width: 0%"></div>
                    </div>
                    <div class="meter-labels">
                        <span>0°C</span>
                        <span>50°C</span>
                    </div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-title">Humidity</div>
                <div class="sensor-value">
                    <span id="humidityValue">--</span>
                    <span class="sensor-unit">%</span>
                </div>
                <div class="meter-container">
                    <div class="meter-bar">
                        <div class="meter-fill" id="humidityMeter" style="width: 0%"></div>
                    </div>
                    <div class="meter-labels">
                        <span>0%</span>
                        <span>100%</span>
                    </div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-title">Pressure</div>
                <div class="sensor-value">
                    <span id="pressureValue">--</span>
                    <span class="sensor-unit">hPa</span>
                </div>
                <div class="meter-container">
                    <div class="meter-bar">
                        <div class="meter-fill" id="pressureMeter" style="width: 0%"></div>
                    </div>
                    <div class="meter-labels">
                        <span>900</span>
                        <span>1100</span>
                    </div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-title">Luminance</div>
                <div class="sensor-value">
                    <span id="lightValue">--</span>
                    <span class="sensor-unit">lux</span>
                </div>
                <div class="meter-container">
                    <div class="meter-bar">
                        <div class="meter-fill" id="lightMeter" style="width: 0%"></div>
                    </div>
                    <div class="meter-labels">
                        <span>0</span>
                        <span>1000</span>
                    </div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-title">Gas Resistance</div>
                <div class="sensor-value">
                    <span id="gasValue">--</span>
                    <span class="sensor-unit">Ω</span>
                </div>
                <div class="meter-container">
                    <div class="meter-bar">
                        <div class="meter-fill" id="gasMeter" style="width: 0%"></div>
                    </div>
                    <div class="meter-labels">
                        <span>0</span>
                        <span>50k</span>
                    </div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-title">Air Quality</div>
                <div class="sensor-value">
                    <span id="aqiValue">--</span>
                    <span class="sensor-unit">%</span>
                </div>
                <div class="meter-container">
                    <div class="meter-bar">
                        <div class="meter-fill" id="aqiMeter" style="width: 0%"></div>
                    </div>
                    <div class="meter-labels">
                        <span>0%</span>
                        <span>100%</span>
                    </div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-title">Color Temp</div>
                <div class="sensor-value">
                    <span id="colorTempValue">--</span>
                    <span class="sensor-unit">K</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                    <div id="colorPatch" style="width: 50px; height: 50px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--card-bg); flex-shrink: 0;"></div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 0.75em; color: var(--text-secondary); margin-bottom: 3px;">Light Color</div>
                        <div id="colorDescription" style="font-size: 0.8em; color: var(--text-primary); font-weight: 500; word-wrap: break-word;">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align: center; color: var(--text-white); margin: 30px 0; font-size: 0.9em; font-weight: normal;">
            <span style="opacity: 0.9;">Data received: </span>
            <span id="dataReceivedTime">--</span>
        </div>

        <div class="historical-section">
            <div class="section-title">
                <span>Historical Data</span>
                <div class="time-selector">
                    <button class="time-btn" onclick="loadHistoricalData(1, this)">1h</button>
                    <button class="time-btn" onclick="loadHistoricalData(6, this)">6h</button>
                    <button class="time-btn active" onclick="loadHistoricalData(24, this)">24h</button>
                    <button class="time-btn" onclick="loadHistoricalData(48, this)">48h</button>
                    <button class="time-btn" onclick="loadHistoricalData(168, this)">7d</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="historicalChart"></canvas>
            </div>
            <div class="expand-button" id="expandButton" onclick="toggleAdditionalCharts()">
                <div class="expand-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                    </svg>
                </div>
            </div>
            <div class="additional-charts" id="additionalCharts">
                <div class="additional-chart-container">
                    <div class="chart-title">Temperature</div>
                    <canvas id="tempChart"></canvas>
                </div>
                <div class="additional-chart-container">
                    <div class="chart-title">Humidity</div>
                    <canvas id="humidityChart"></canvas>
                </div>
                <div class="additional-chart-container">
                    <div class="chart-title">Pressure</div>
                    <canvas id="pressureChart"></canvas>
                </div>
                <div class="additional-chart-container">
                    <div class="chart-title">Luminance</div>
                    <canvas id="luminanceChart"></canvas>
                </div>
                <div class="additional-chart-container">
                    <div class="chart-title">Gas Resistance</div>
                    <canvas id="gasChart"></canvas>
                </div>
                <div class="additional-chart-container">
                    <div class="chart-title">Air Quality Index</div>
                    <canvas id="aqiChart"></canvas>
                </div>
                <div class="additional-chart-container">
                    <div class="chart-title">Color Temperature</div>
                    <canvas id="colorTempChart"></canvas>
                </div>
            </div>
            <div class="stats-panel" id="statsPanel">
                <div class="stat-item">
                    <div class="stat-label">Temperature (°C)</div>
                    <div class="stat-values">
                        <div class="stat-box min">
                            <div class="stat-value-label">Min</div>
                            <div class="stat-value"><span id="statTempMin">--</span></div>
                        </div>
                        <div class="stat-box max">
                            <div class="stat-value-label">Max</div>
                            <div class="stat-value"><span id="statTempMax">--</span></div>
                        </div>
                        <div class="stat-box avg">
                            <div class="stat-value-label">Avg</div>
                            <div class="stat-value"><span id="statTempAvg">--</span></div>
                        </div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Humidity (%)</div>
                    <div class="stat-values">
                        <div class="stat-box min">
                            <div class="stat-value-label">Min</div>
                            <div class="stat-value"><span id="statHumidityMin">--</span></div>
                        </div>
                        <div class="stat-box max">
                            <div class="stat-value-label">Max</div>
                            <div class="stat-value"><span id="statHumidityMax">--</span></div>
                        </div>
                        <div class="stat-box avg">
                            <div class="stat-value-label">Avg</div>
                            <div class="stat-value"><span id="statHumidityAvg">--</span></div>
                        </div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Pressure (hPa)</div>
                    <div class="stat-values">
                        <div class="stat-box min">
                            <div class="stat-value-label">Min</div>
                            <div class="stat-value"><span id="statPressureMin">--</span></div>
                        </div>
                        <div class="stat-box max">
                            <div class="stat-value-label">Max</div>
                            <div class="stat-value"><span id="statPressureMax">--</span></div>
                        </div>
                        <div class="stat-box avg">
                            <div class="stat-value-label">Avg</div>
                            <div class="stat-value"><span id="statPressureAvg">--</span></div>
                        </div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Luminance (lux)</div>
                    <div class="stat-values">
                        <div class="stat-box min">
                            <div class="stat-value-label">Min</div>
                            <div class="stat-value"><span id="statLightMin">--</span></div>
                        </div>
                        <div class="stat-box max">
                            <div class="stat-value-label">Max</div>
                            <div class="stat-value"><span id="statLightMax">--</span></div>
                        </div>
                        <div class="stat-box avg">
                            <div class="stat-value-label">Avg</div>
                            <div class="stat-value"><span id="statLightAvg">--</span></div>
                        </div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Gas Resistance (kΩ)</div>
                    <div class="stat-values">
                        <div class="stat-box min">
                            <div class="stat-value-label">Min</div>
                            <div class="stat-value"><span id="statGasMin">--</span></div>
                        </div>
                        <div class="stat-box max">
                            <div class="stat-value-label">Max</div>
                            <div class="stat-value"><span id="statGasMax">--</span></div>
                        </div>
                        <div class="stat-box avg">
                            <div class="stat-value-label">Avg</div>
                            <div class="stat-value"><span id="statGasAvg">--</span></div>
                        </div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Air Quality (%)</div>
                    <div class="stat-values">
                        <div class="stat-box min">
                            <div class="stat-value-label">Min</div>
                            <div class="stat-value"><span id="statAqiMin">--</span></div>
                        </div>
                        <div class="stat-box max">
                            <div class="stat-value-label">Max</div>
                            <div class="stat-value"><span id="statAqiMax">--</span></div>
                        </div>
                        <div class="stat-box avg">
                            <div class="stat-value-label">Avg</div>
                            <div class="stat-value"><span id="statAqiAvg">--</span></div>
                        </div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Color Temp (K)</div>
                    <div class="stat-values">
                        <div class="stat-box min">
                            <div class="stat-value-label">Min</div>
                            <div class="stat-value"><span id="statColorTempMin">--</span></div>
                        </div>
                        <div class="stat-box max">
                            <div class="stat-value-label">Max</div>
                            <div class="stat-value"><span id="statColorTempMax">--</span></div>
                        </div>
                        <div class="stat-box avg">
                            <div class="stat-value-label">Avg</div>
                            <div class="stat-value"><span id="statColorTempAvg">--</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Chart.js configuration
        const chartConfig = {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Temperature (°C)',
                        data: [],
                        borderColor: 'rgb(205, 60, 101)',
                        backgroundColor: 'rgba(205, 60, 101, 0.1)',
                        tension: 0.4,
                        spanGaps: false,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Humidity (%)',
                        data: [],
                        borderColor: 'rgb(62, 145, 190)',
                        backgroundColor: 'rgba(62, 145, 190, 0.1)',
                        tension: 0.4,
                        spanGaps: false,
                        yAxisID: 'y1',
                    },
                    {
                        label: 'Pressure (hPa)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4,
                        spanGaps: false,
                        yAxisID: 'y2',
                    },
                    {
                        label: 'Luminance (lux)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.4,
                        spanGaps: false,
                        yAxisID: 'y3',
                    },
                    {
                        label: 'Gas Resistance (Ω)',
                        data: [],
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        tension: 0.4,
                        spanGaps: false,
                        yAxisID: 'y4',
                    },
                    {
                        label: 'Air Quality Index (%)',
                        data: [],
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        tension: 0.4,
                        spanGaps: false,
                        yAxisID: 'y5',
                    },
                    {
                        label: 'Color Temperature (K)',
                        data: [],
                        borderColor: 'rgb(255, 206, 86)',
                        backgroundColor: 'rgba(255, 206, 86, 0.1)',
                        tension: 0.4,
                        spanGaps: false,
                        yAxisID: 'y6',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                    plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#666'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(context) {
                                const index = context[0].dataIndex;
                                const label = context[0].chart.data.labels[index];
                                return label || 'Unknown time';
                            },
                            label: function(context) {
                                const value = context.parsed.y;
                                if (value === null || value === undefined) {
                                    return null;
                                }
                                const label = context.dataset.label || '';
                                const formattedValue = typeof value === 'number' ? value.toFixed(2) : value;
                                return `${label}: ${formattedValue}`;
                            },
                            afterBody: function(context) {
                                // Show timestamp if available
                                const index = context[0].dataIndex;
                                const chart = context[0].chart;
                                if (chart.data.rawData && chart.data.rawData[index]) {
                                    const timestamp = chart.data.rawData[index].timestamp;
                                    if (timestamp) {
                                        const date = new Date(timestamp * 1000);
                                        return `Time: ${date.toLocaleString()}`;
                                    }
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time',
                            color: '#666'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            color: '#666'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Temperature (°C)',
                            color: '#666'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            color: '#666'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Humidity (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                    y2: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Pressure (hPa)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                    y3: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Luminance (lux)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                    y4: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Gas Resistance (Ω)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                    y5: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Air Quality Index (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                    y6: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Color Temperature (K)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        };

        let historicalChart = null;
        let tempChart = null;
        let humidityChart = null;
        let pressureChart = null;
        let luminanceChart = null;
        let gasChart = null;
        let aqiChart = null;
        let colorTempChart = null;
        let currentHours = 24;
        let additionalChartsExpanded = false;

        // Helper function to create a chart configuration
        function createChartConfig(label, borderColor, backgroundColor, yAxisTitle, yMin, yMax) {
            return {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: label,
                        data: [],
                        borderColor: borderColor,
                        backgroundColor: backgroundColor,
                        tension: 0.4,
                        spanGaps: false,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 20,
                                callback: function(value, index, ticks) {
                                    const label = this.getLabelForValue(value);
                                    // Always show tilde gap indicators
                                    if (label === '~') {
                                        return '~';
                                    }
                                    // For other labels, let Chart.js handle auto-skipping
                                    return label;
                                }
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: yAxisTitle
                            },
                            ...(yMin !== undefined && { min: yMin }),
                            ...(yMax !== undefined && { max: yMax })
                        }
                    }
                }
            };
        }

        // Initialize charts
        function initChart() {
            const ctx = document.getElementById('historicalChart').getContext('2d');
            historicalChart = new Chart(ctx, chartConfig);
            
            // Initialize Temperature chart
            const tempCtx = document.getElementById('tempChart').getContext('2d');
            tempChart = new Chart(tempCtx, createChartConfig(
                'Temperature (°C)',
                'rgb(205, 60, 101)',
                'rgba(205, 60, 101, 0.1)',
                'Temperature (°C)'
            ));
            
            // Initialize Humidity chart
            const humidityCtx = document.getElementById('humidityChart').getContext('2d');
            humidityChart = new Chart(humidityCtx, createChartConfig(
                'Humidity (%)',
                'rgb(62, 145, 190)',
                'rgba(62, 145, 190, 0.1)',
                'Humidity (%)',
                0,
                100
            ));
            
            // Initialize Pressure chart
            const pressureCtx = document.getElementById('pressureChart').getContext('2d');
            pressureChart = new Chart(pressureCtx, createChartConfig(
                'Pressure (hPa)',
                'rgb(255, 99, 132)',
                'rgba(255, 99, 132, 0.1)',
                'Pressure (hPa)'
            ));
            
            // Initialize Luminance chart
            const luminanceCtx = document.getElementById('luminanceChart').getContext('2d');
            luminanceChart = new Chart(luminanceCtx, createChartConfig(
                'Luminance (lux)',
                'rgb(75, 192, 192)',
                'rgba(75, 192, 192, 0.1)',
                'Luminance (lux)'
            ));
            
            // Initialize Gas Resistance chart
            const gasCtx = document.getElementById('gasChart').getContext('2d');
            gasChart = new Chart(gasCtx, createChartConfig(
                'Gas Resistance (Ω)',
                'rgb(255, 159, 64)',
                'rgba(255, 159, 64, 0.1)',
                'Gas Resistance (Ω)'
            ));
            
            // Initialize AQI chart
            const aqiCtx = document.getElementById('aqiChart').getContext('2d');
            aqiChart = new Chart(aqiCtx, createChartConfig(
                'Air Quality Index (%)',
                'rgb(153, 102, 255)',
                'rgba(153, 102, 255, 0.1)',
                'AQI (%)',
                0,
                100
            ));
            
            // Initialize Color Temperature chart
            const colorTempCtx = document.getElementById('colorTempChart').getContext('2d');
            colorTempChart = new Chart(colorTempCtx, createChartConfig(
                'Color Temperature (K)',
                'rgb(255, 206, 86)',
                'rgba(255, 206, 86, 0.1)',
                'Temperature (K)'
            ));
        }

        // Toggle additional charts visibility
        function toggleAdditionalCharts() {
            const additionalCharts = document.getElementById('additionalCharts');
            const expandButton = document.getElementById('expandButton');
            
            additionalChartsExpanded = !additionalChartsExpanded;
            
            if (additionalChartsExpanded) {
                additionalCharts.classList.add('expanded');
                expandButton.classList.add('expanded');
                // Load data for additional charts if not already loaded
                if (tempChart && humidityChart && pressureChart && luminanceChart && gasChart && aqiChart && colorTempChart) {
                    loadAdditionalChartsData();
                }
            } else {
                additionalCharts.classList.remove('expanded');
                expandButton.classList.remove('expanded');
            }
        }

        // Convert Kelvin to RGB (color temperature algorithm)
        function kelvinToRGB(kelvin) {
            // Clamp to reasonable range
            kelvin = Math.max(1000, Math.min(40000, kelvin));
            
            let temp = kelvin / 100;
            let red, green, blue;

            // Calculate red
            if (temp <= 66) {
                red = 255;
            } else {
                red = temp - 60;
                red = 329.698727446 * Math.pow(red, -0.1332047592);
                red = Math.max(0, Math.min(255, red));
            }

            // Calculate green
            if (temp <= 66) {
                green = temp;
                green = 99.4708025861 * Math.log(green) - 161.1195681661;
                green = Math.max(0, Math.min(255, green));
            } else {
                green = temp - 60;
                green = 288.1221695283 * Math.pow(green, -0.0755148492);
                green = Math.max(0, Math.min(255, green));
            }

            // Calculate blue
            if (temp >= 66) {
                blue = 255;
            } else {
                if (temp <= 19) {
                    blue = 0;
                } else {
                    blue = temp - 10;
                    blue = 138.5177312231 * Math.log(blue) - 305.0447927307;
                    blue = Math.max(0, Math.min(255, blue));
                }
            }

            return {
                r: Math.round(red),
                g: Math.round(green),
                b: Math.round(blue)
            };
        }

        // Get color description from Kelvin
        function getColorDescription(kelvin) {
            if (kelvin < 2000) return 'Very Warm (Candlelight)';
            if (kelvin < 3000) return 'Warm (Incandescent)';
            if (kelvin < 4000) return 'Neutral Warm';
            if (kelvin < 5000) return 'Neutral (Fluorescent)';
            if (kelvin < 6500) return 'Cool White';
            if (kelvin < 8000) return 'Daylight';
            return 'Very Cool (Sky)';
        }

        // Update meter bars
        function updateMeters(data) {
            if (!data) return;

            // Temperature (0-50°C range)
            if (data.temperature !== null && data.temperature !== undefined) {
                const tempPercent = Math.min(100, Math.max(0, (data.temperature / 50) * 100));
                document.getElementById('tempMeter').style.width = tempPercent + '%';
                document.getElementById('tempValue').textContent = data.temperature.toFixed(1);
            }

            // Humidity (0-100% range)
            if (data.humidity !== null && data.humidity !== undefined) {
                const humidityPercent = Math.min(100, Math.max(0, data.humidity));
                document.getElementById('humidityMeter').style.width = humidityPercent + '%';
                document.getElementById('humidityValue').textContent = data.humidity.toFixed(1);
            }

            // Pressure (900-1100 hPa range)
            if (data.pressure !== null && data.pressure !== undefined) {
                const pressurePercent = Math.min(100, Math.max(0, ((data.pressure - 900) / 200) * 100));
                document.getElementById('pressureMeter').style.width = pressurePercent + '%';
                document.getElementById('pressureValue').textContent = data.pressure.toFixed(1);
            }

            // Luminance (0-1000 lux range, but can be higher)
            if (data.light !== null && data.light !== undefined) {
                const lightPercent = Math.min(100, Math.max(0, (data.light / 1000) * 100));
                document.getElementById('lightMeter').style.width = lightPercent + '%';
                document.getElementById('lightValue').textContent = data.light.toFixed(0);
            }

            // Gas Resistance (0-50000 Ω range)
            if (data.gas !== null && data.gas !== undefined) {
                const gasPercent = Math.min(100, Math.max(0, (data.gas / 50000) * 100));
                document.getElementById('gasMeter').style.width = gasPercent + '%';
                // Format gas resistance nicely (show kΩ if >= 1000)
                const gasValueEl = document.getElementById('gasValue');
                const gasUnitEl = gasValueEl.nextElementSibling;
                if (data.gas >= 1000) {
                    gasValueEl.textContent = (data.gas / 1000).toFixed(1);
                    gasUnitEl.textContent = 'kΩ';
                } else {
                    gasValueEl.textContent = data.gas.toFixed(0);
                    gasUnitEl.textContent = 'Ω';
                }
            }

            // Air Quality Index (0-100% range)
            if (data.aqi !== null && data.aqi !== undefined) {
                const aqiPercent = Math.min(100, Math.max(0, data.aqi));
                document.getElementById('aqiMeter').style.width = aqiPercent + '%';
                document.getElementById('aqiValue').textContent = data.aqi.toFixed(1);
            }

            // Color Temperature
            if (data.color_temperature !== null && data.color_temperature !== undefined) {
                document.getElementById('colorTempValue').textContent = Math.round(data.color_temperature);
                const rgb = kelvinToRGB(data.color_temperature);
                const colorPatch = document.getElementById('colorPatch');
                colorPatch.style.backgroundColor = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                document.getElementById('colorDescription').textContent = getColorDescription(data.color_temperature);
            }
        }

        // Load current sensor readings
        async function loadCurrentData() {
            try {
                const response = await fetch('/api/current');
                const result = await response.json();

                if (result.success && result.data) {
                    updateMeters(result.data);
                    
                    const date = new Date(result.data.timestamp * 1000);
                    const formattedDate = date.toLocaleString();
                    
                    // Update "Data received" timestamp
                    document.getElementById('dataReceivedTime').textContent = formattedDate;
                } else {
                    // No data available
                    document.getElementById('dataReceivedTime').textContent = 'No data available';
                }

                // Update status indicator
                const statusIndicator = document.getElementById('statusIndicator');
                
                if (result.sleeping) {
                    statusIndicator.classList.remove('active');
                    statusIndicator.classList.add('sleeping');
                } else {
                    statusIndicator.classList.remove('sleeping');
                    statusIndicator.classList.add('active');
                }
            } catch (error) {
                console.error('Error loading current data:', error);
            }
        }

        // Load statistics for the selected time range
        async function loadStats(hours) {
            try {
                const response = await fetch(`/api/stats?hours=${hours}`);
                const result = await response.json();

                if (result.success && result.stats) {
                    const stats = result.stats;
                    
                    // Helper to format value
                    const format = (val, decimals = 1) => {
                        if (val === null || val === undefined) return '--';
                        return Number(val).toFixed(decimals);
                    };
                    
                    // Temperature
                    document.getElementById('statTempMin').textContent = format(stats.min_temp);
                    document.getElementById('statTempMax').textContent = format(stats.max_temp);
                    document.getElementById('statTempAvg').textContent = format(stats.avg_temp);
                    
                    // Humidity
                    document.getElementById('statHumidityMin').textContent = format(stats.min_humidity);
                    document.getElementById('statHumidityMax').textContent = format(stats.max_humidity);
                    document.getElementById('statHumidityAvg').textContent = format(stats.avg_humidity);
                    
                    // Pressure
                    document.getElementById('statPressureMin').textContent = format(stats.min_pressure);
                    document.getElementById('statPressureMax').textContent = format(stats.max_pressure);
                    document.getElementById('statPressureAvg').textContent = format(stats.avg_pressure);
                    
                    // Light
                    document.getElementById('statLightMin').textContent = format(stats.min_light, 0);
                    document.getElementById('statLightMax').textContent = format(stats.max_light, 0);
                    document.getElementById('statLightAvg').textContent = format(stats.avg_light, 0);
                    
                    // Gas (convert to kΩ - divide by 1000)
                    const gasMin = stats.min_gas ? (stats.min_gas / 1000).toFixed(1) : '--';
                    const gasMax = stats.max_gas ? (stats.max_gas / 1000).toFixed(1) : '--';
                    const gasAvg = stats.avg_gas ? (stats.avg_gas / 1000).toFixed(1) : '--';
                    document.getElementById('statGasMin').textContent = gasMin;
                    document.getElementById('statGasMax').textContent = gasMax;
                    document.getElementById('statGasAvg').textContent = gasAvg;
                    
                    // AQI
                    document.getElementById('statAqiMin').textContent = format(stats.min_aqi);
                    document.getElementById('statAqiMax').textContent = format(stats.max_aqi);
                    document.getElementById('statAqiAvg').textContent = format(stats.avg_aqi);
                    
                    // Color Temperature
                    document.getElementById('statColorTempMin').textContent = format(stats.min_color_temp, 0);
                    document.getElementById('statColorTempMax').textContent = format(stats.max_color_temp, 0);
                    document.getElementById('statColorTempAvg').textContent = format(stats.avg_color_temp, 0);
                } else {
                    // Clear stats if no data
                    document.querySelectorAll('.stat-value span:last-child').forEach(el => {
                        if (el.id && el.id.startsWith('stat')) {
                            el.textContent = '--';
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load historical data
        async function loadHistoricalData(hours, buttonElement) {
            currentHours = hours;
            
            // Update active button
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Load stats for the selected time range
            loadStats(hours);

            try {
                const response = await fetch(`/api/historical?hours=${hours}`);
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    // Create labels and data arrays with null values for gaps (visual break, no tilde label)
                    const gapThreshold = 29 * 60 * 1000; // 29 minutes in milliseconds
                    
                    // Build labels array once (with null for gaps to maintain alignment)
                    const labels = [];
                    for (let i = 0; i < result.data.length; i++) {
                        const date = new Date(result.data[i].timestamp * 1000);
                        labels.push(date.toLocaleTimeString());
                        
                        // Insert null for gap if there's a gap after this point
                        if (i < result.data.length - 1) {
                            const currentTime = result.data[i].timestamp * 1000;
                            const nextTime = result.data[i + 1].timestamp * 1000;
                            const timeDiff = nextTime - currentTime;
                            
                            if (timeDiff > gapThreshold) {
                                labels.push(null); // null to match null in data arrays and maintain alignment
                            }
                        }
                    }
                    
                    // Build data arrays with null values for gaps (using the same gap pattern as labels)
                    const createDataWithGaps = (getValue) => {
                        const data = [];
                        let labelIndex = 0;
                        for (let i = 0; i < result.data.length; i++) {
                            data.push(getValue(result.data[i]));
                            labelIndex++;
                            
                            // Insert null for gap if there's a gap after this point
                            if (i < result.data.length - 1) {
                                const currentTime = result.data[i].timestamp * 1000;
                                const nextTime = result.data[i + 1].timestamp * 1000;
                                const timeDiff = nextTime - currentTime;
                                
                                if (timeDiff > gapThreshold) {
                                    data.push(null);
                                    labelIndex++; // Skip the empty label
                                }
                            }
                        }
                        return data;
                    };

                    historicalChart.data.labels = labels;
                    historicalChart.data.datasets[0].data = createDataWithGaps(d => d.temperature);
                    historicalChart.data.datasets[1].data = createDataWithGaps(d => d.humidity);
                    historicalChart.data.datasets[2].data = createDataWithGaps(d => d.pressure);
                    historicalChart.data.datasets[3].data = createDataWithGaps(d => d.light);
                    historicalChart.data.datasets[4].data = createDataWithGaps(d => d.gas);
                    historicalChart.data.datasets[5].data = createDataWithGaps(d => d.aqi || null);
                    historicalChart.data.datasets[6].data = createDataWithGaps(d => d.color_temperature || null);
                    
                    // Store raw data for tooltips (mapping label index to original data)
                    historicalChart.data.rawData = [];
                    let rawIndex = 0;
                    for (let i = 0; i < labels.length; i++) {
                        if (labels[i] !== null && rawIndex < result.data.length) {
                            historicalChart.data.rawData[i] = result.data[rawIndex];
                            rawIndex++;
                        } else {
                            historicalChart.data.rawData[i] = null;
                        }
                    }
                    
                    historicalChart.update();
                    
                    // Update additional charts if they're visible
                    if (additionalChartsExpanded && tempChart && humidityChart && pressureChart && luminanceChart && gasChart && aqiChart && colorTempChart) {
                        loadAdditionalChartsData(result.data);
                    }
                } else {
                    console.log('No historical data available');
                }
            } catch (error) {
                console.error('Error loading historical data:', error);
            }
        }

        // Load data for additional charts
        function loadAdditionalChartsData(data) {
            if (!data) {
                // Fetch data if not provided
                fetch(`/api/historical?hours=${currentHours}`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.success && result.data && result.data.length > 0) {
                            updateAdditionalCharts(result.data);
                        }
                    })
                    .catch(error => console.error('Error loading additional charts data:', error));
            } else {
                updateAdditionalCharts(data);
            }
        }

        // Update additional charts with data
        function updateAdditionalCharts(data) {
            const gapThreshold = 29 * 60 * 1000; // 29 minutes in milliseconds
            
            // Helper to create data with gaps
            const createDataWithGaps = (getValue) => {
                const chartData = [];
                for (let i = 0; i < data.length; i++) {
                    chartData.push(getValue(data[i]));
                    
                    // Insert null for gap if there's a gap after this point
                    if (i < data.length - 1) {
                        const currentTime = data[i].timestamp * 1000;
                        const nextTime = data[i + 1].timestamp * 1000;
                        const timeDiff = nextTime - currentTime;
                        
                        if (timeDiff > gapThreshold) {
                            chartData.push(null);
                        }
                    }
                }
                return chartData;
            };
            
            // Create labels with null for gaps (to match null in data arrays)
            const labels = [];
            for (let i = 0; i < data.length; i++) {
                const date = new Date(data[i].timestamp * 1000);
                labels.push(date.toLocaleTimeString());
                
                // Insert null for gap if there's a gap after this point
                if (i < data.length - 1) {
                    const currentTime = data[i].timestamp * 1000;
                    const nextTime = data[i + 1].timestamp * 1000;
                    const timeDiff = nextTime - currentTime;
                    
                    if (timeDiff > gapThreshold) {
                        labels.push(null);
                    }
                }
            }
            
            // Store raw data mapping for tooltips
            const storeRawData = (chart) => {
                if (!chart) return;
                chart.data.rawData = [];
                let rawIndex = 0;
                for (let i = 0; i < labels.length; i++) {
                    if (labels[i] !== null && rawIndex < data.length) {
                        chart.data.rawData[i] = data[rawIndex];
                        rawIndex++;
                    } else {
                        chart.data.rawData[i] = null;
                    }
                }
            };
            
            if (tempChart) {
                tempChart.data.labels = labels;
                tempChart.data.datasets[0].data = createDataWithGaps(d => d.temperature || null);
                storeRawData(tempChart);
                tempChart.update();
            }
            
            if (humidityChart) {
                humidityChart.data.labels = labels;
                humidityChart.data.datasets[0].data = createDataWithGaps(d => d.humidity || null);
                storeRawData(humidityChart);
                humidityChart.update();
            }
            
            if (pressureChart) {
                pressureChart.data.labels = labels;
                pressureChart.data.datasets[0].data = createDataWithGaps(d => d.pressure || null);
                storeRawData(pressureChart);
                pressureChart.update();
            }
            
            if (luminanceChart) {
                luminanceChart.data.labels = labels;
                luminanceChart.data.datasets[0].data = createDataWithGaps(d => d.light || null);
                storeRawData(luminanceChart);
                luminanceChart.update();
            }
            
            if (gasChart) {
                gasChart.data.labels = labels;
                gasChart.data.datasets[0].data = createDataWithGaps(d => d.gas || null);
                storeRawData(gasChart);
                gasChart.update();
            }
            
            if (aqiChart) {
                aqiChart.data.labels = labels;
                aqiChart.data.datasets[0].data = createDataWithGaps(d => d.aqi || null);
                storeRawData(aqiChart);
                aqiChart.update();
            }
            
            if (colorTempChart) {
                colorTempChart.data.labels = labels;
                colorTempChart.data.datasets[0].data = createDataWithGaps(d => d.color_temperature || null);
                storeRawData(colorTempChart);
                colorTempChart.update();
            }
        }

        // Dark mode toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update toggle icon - show icon for the NEW theme
            updateThemeIcon(newTheme);
            
            // Update chart colors
            updateChartColors(newTheme);
        }

        // Update theme icon based on current theme
        function updateThemeIcon(theme) {
            const svg = document.getElementById('themeIcon');
            if (!svg) return;
            
            if (theme === 'dark') {
                // Show sun icon when dark mode is ON (clicking will switch to light)
                svg.innerHTML = '<path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5M3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8m10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0m-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0m9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708"/>';
            } else {
                // Show moon-stars icon when light mode is ON (clicking will switch to dark)
                svg.innerHTML = '<path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278M4.858 1.311A7.27 7.27 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.32 7.32 0 0 0 5.205-2.162q-.506.063-1.029.063c-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286"/><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.73 1.73 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.73 1.73 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.73 1.73 0 0 0 1.097-1.097zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>';
            }
        }

        // Update chart colors based on theme
        function updateChartColors(theme) {
            const isDark = theme === 'dark';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDark ? '#b0b0b0' : '#666';
            
            // Update main chart
            if (historicalChart) {
                historicalChart.options.scales.x.grid.color = gridColor;
                historicalChart.options.scales.x.ticks.color = textColor;
                historicalChart.options.scales.x.title.color = textColor;
                historicalChart.options.scales.y.grid.color = gridColor;
                historicalChart.options.scales.y.ticks.color = textColor;
                historicalChart.options.scales.y.title.color = textColor;
                historicalChart.options.scales.y1.ticks.color = textColor;
                historicalChart.options.scales.y1.title.color = textColor;
                historicalChart.options.scales.y2.ticks.color = textColor;
                historicalChart.options.scales.y2.title.color = textColor;
                historicalChart.options.scales.y3.ticks.color = textColor;
                historicalChart.options.scales.y3.title.color = textColor;
                historicalChart.options.scales.y4.ticks.color = textColor;
                historicalChart.options.scales.y4.title.color = textColor;
                historicalChart.options.scales.y5.ticks.color = textColor;
                historicalChart.options.scales.y5.title.color = textColor;
                historicalChart.options.scales.y6.ticks.color = textColor;
                historicalChart.options.scales.y6.title.color = textColor;
                historicalChart.options.plugins.legend.labels.color = textColor;
                historicalChart.update('none');
            }
            
            // Update additional charts
            const charts = [tempChart, humidityChart, pressureChart, luminanceChart, gasChart, aqiChart, colorTempChart];
            charts.forEach(chart => {
                if (chart) {
                    chart.options.scales.x.grid.color = gridColor;
                    chart.options.scales.x.ticks.color = textColor;
                    chart.options.scales.x.title.color = textColor;
                    chart.options.scales.y.grid.color = gridColor;
                    chart.options.scales.y.ticks.color = textColor;
                    chart.options.scales.y.title.color = textColor;
                    chart.options.plugins.legend.labels.color = textColor;
                    chart.update('none');
                }
            });
        }

        // Initialize theme from localStorage
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Update toggle icon based on current theme
            updateThemeIcon(savedTheme);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            initChart();
            // Update chart colors after initialization
            setTimeout(() => updateChartColors(currentTheme), 100);
            loadCurrentData();
            loadHistoricalData(24);
            loadStats(24); // Load initial stats

            // Update current data every 5 seconds
            setInterval(loadCurrentData, 5000);
            
            // Update historical data and stats every 30 seconds
            setInterval(() => {
                loadHistoricalData(currentHours);
                loadStats(currentHours);
            }, 30000);
        });
    </script>
</body>
</html>

